(function (e) {
    e.fn.ssslick = function (l) {
        if (c[l]) {
            return c[l].apply(this, Array.prototype.slice.call(arguments, 1))
        } else {
            if (typeof l === "object" || !l) {
                return c.init.apply(this, arguments)
            } else {
                e.error("Method " + l + " does not exists.")
            }
        }
    };
    var c = {},
        d = {
            data: [],
            keepJSONItemsOnTop: false,
            height: null,
            background: "",
            selectText: "",
            defaultSelectedIndex: null,
            truncateDescription: true,
            imagePosition: "left",
            showSelectedHTML: true,
            clickOffToClose: true,
            embedCSS: true,
            onSelected: function () {}
        },
        i = '<div class="ss-select"><input class="ss-selected-value" type="hidden" /><a class="ss-selected"></a><span class="ss-pointer ss-pointer-down"></span></div>',
        a = '<ul class="ss-options"></ul>',
        b = '';
    c.init = function (l) {
        var l = e.extend({}, d, l);
        if (e("#css-ssslick").length <= 0 && l.embedCSS) {
            e(b).appendTo("head")
        }
        return this.each(function () {
            var p = e(this),
                q = p.data("ssslick");
            if (!q) {
                var n = [],
                    o = l.data;
                p.find("option").each(function () {
                    var w = e(this),
                        v = w.data();
                    n.push({
                        text: e.trim(w.text()),
                        value: w.val(),
                        selected: w.is(":selected"),
                        description: v.description,
                        imageSrc: v.imagesrc
                    })
                });
                if (l.keepJSONItemsOnTop) {
                    e.merge(l.data, n)
                } else {
                    l.data = e.merge(n, l.data)
                }
                var m = p,
                    s = e('<div id="' + p.attr("id") + '"></div>');
                p.replaceWith(s);
                p = s;
                p.addClass("ss-container").append(i).append(a);
                var n = p.find(".ss-select"),
                    u = p.find(".ss-options");
                u.css({
                    width: l.width
                });
                n.css({
                    width: l.width,
                    background: l.background
                });
                p.css({
                    width: l.width
                });
                if (l.height != null) {
                    u.css({
                        height: l.height,
                        overflow: "auto"
                    })
                }
                e.each(l.data, function (v, w) {
                    if (w.selected) {
                        l.defaultSelectedIndex = v
                    }
                    u.append('<li><a class="ss-option">' + (w.value ? ' <input class="ss-option-value" type="hidden" value="' + w.value + '" />' : "") + (w.imageSrc ? ' <img class="ss-option-image' + (l.imagePosition == "right" ? " ss-image-right" : "") + '" src="' + w.imageSrc + '" />' : "") + (w.text ? ' <label class="ss-option-text">' + w.text + "</label>" : "") + (w.description ? ' <small class="ss-option-description ss-desc">' + w.description + "</small>" : "") + "</a></li>")
                });
                var t = {
                    settings: l,
                    original: m,
                    selectedIndex: -1,
                    selectedItem: null,
                    selectedData: null
                };
                p.data("ssslick", t);
                if (l.selectText.length > 0 && l.defaultSelectedIndex == null) {
                    p.find(".ss-selected").html(l.selectText)
                } else {
                    var r = (l.defaultSelectedIndex != null && l.defaultSelectedIndex >= 0 && l.defaultSelectedIndex < l.data.length) ? l.defaultSelectedIndex : 0;
                    j(p, r)
                }
                p.find(".ss-select").on("click.ssslick", function () {
                    f(p)
                });
                p.find(".ss-option").on("click.ssslick", function () {
                    j(p, e(this).closest("li").index())
                });
                if (l.clickOffToClose) {
                    u.addClass("ss-click-off-close");
                    p.on("click.ssslick", function (v) {
                        v.stopPropagation()
                    });
                    e("body").on("click", function () {
                        e(".ss-click-off-close").slideUp(50).siblings(".ss-select").find(".ss-pointer").removeClass("ss-pointer-up")
                    })
                }
            }
        })
    };
    c.select = function (l) {
        return this.each(function () {
            if (l.index !== undefined) {
                j(e(this), l.index)
            }
        })
    };
    c.open = function () {
        return this.each(function () {
            var m = e(this),
                l = m.data("ssslick");
            if (l) {
                f(m)
            }
        })
    };
    c.close = function () {
        return this.each(function () {
            var m = e(this),
                l = m.data("ssslick");
            if (l) {
                k(m)
            }
        })
    };
    c.destroy = function () {
        return this.each(function () {
            var n = e(this),
                m = n.data("ssslick");
            if (m) {
                var l = m.original;
                n.removeData("ssslick").unbind(".ssslick").replaceWith(l)
            }
        })
    };

    function j(q, s) {
        var u = q.data("ssslick");
        var r = q.find(".ss-selected"),
            n = r.siblings(".ss-selected-value"),
            v = q.find(".ss-options"),
            l = r.siblings(".ss-pointer"),
            p = q.find(".ss-option").eq(s),
            m = p.closest("li"),
            o = u.settings,
            t = u.settings.data[s];
        q.find(".ss-option").removeClass("ss-option-selected");
        p.addClass("ss-option-selected");
        u.selectedIndex = s;
        u.selectedItem = m;
        u.selectedData = t;
        if (o.showSelectedHTML) {
            r.html((t.imageSrc ? '<img class="ss-selected-image' + (o.imagePosition == "right" ? " ss-image-right" : "") + '" src="' + t.imageSrc + '" />' : "") + (t.text ? '<label class="ss-selected-text">' + t.text + "</label>" : "") + (t.description ? '<small class="ss-selected-description ss-desc' + (o.truncateDescription ? " ss-selected-description-truncated" : "") + '" >' + t.description + "</small>" : ""))
        } else {
            r.html(t.text)
        }
        n.val(t.value);
        u.original.val(t.value);
        q.data("ssslick", u);
        k(q);
        g(q);
        if (typeof o.onSelected == "function") {
            o.onSelected.call(this, u)
        }
    }

    function f(p) {
        var o = p.find(".ss-select"),
            m = o.siblings(".ss-options"),
            l = o.find(".ss-pointer"),
            n = m.is(":visible");
        e(".ss-click-off-close").not(m).slideUp(50);
        e(".ss-pointer").removeClass("ss-pointer-up");
        if (n) {
            m.slideUp("fast");
            l.removeClass("ss-pointer-up")
        } else {
            m.slideDown("fast");
            l.addClass("ss-pointer-up")
        }
        h(p)
    }

    function k(l) {
        l.find(".ss-options").slideUp(50);
        l.find(".ss-pointer").removeClass("ss-pointer-up").removeClass("ss-pointer-up")
    }

    function g(o) {
        var n = o.find(".ss-select").css("height");
        var m = o.find(".ss-selected-description");
        var l = o.find(".ss-selected-image");
        if (m.length <= 0 && l.length > 0) {
            o.find(".ss-selected-text").css("lineHeight", n)
        }
    }

    function h(l) {
        l.find(".ss-option").each(function () {
            var p = e(this);
            var n = p.css("height");
            var o = p.find(".ss-option-description");
            var m = l.find(".ss-option-image");
            if (o.length <= 0 && m.length > 0) {
                p.find(".ss-option-text").css("lineHeight", n)
            }
        })
    }
})(jQuery);
